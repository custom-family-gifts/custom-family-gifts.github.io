<!DOCTYPE html>
<html>
  <head>
    <title>Custom Family Gifts</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="index.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">
    <link rel="stylesheet" href="./base/common.css">
    <script src="./base/api.js"></script>
  </head>
  <body>
    <h3>Etsy OAUTH</h3>
    <a target="_blank" id="oauthlink" href="https://www.getsreplacedinscript.com">
      <button>auth</button>
    </a>

    <script>
      var urlParams = API.getUrlParams();
      var client_id = urlParams.client_id;
      var redirect_uri = encodeURIComponent('https://smile.customfamilygifts.com/oauth_etsy');
      var scopes = encodeURIComponent(`transactions_w email_r listings_w profile_r shops_w`);
      var state = '11234567890';
      var code_challenge = urlParams.code_challenge; // 
      /* 
        PKCE Proof Key for Code Exchange
        veri
        code challenge = base64(SHA256('vvkdljkejllufrvbhgeiegrnvufrhvrffnkvcknjvcfg')) = 'NjJENzRDQUQ1REYxNkY3OEJDMTAzOTlBMzFFRThGM0ZFQjkwNUM0MkE0OUQ5RDZDQjgxRjEyMEQ3MzZBOUJCOA==' // that's the code challenge
      */
      var oauth_get_url = `https://www.etsy.com/oauth/connect?response_type=code`;
      oauth_get_url += `&redirect_uri=${redirect_uri}`;
      oauth_get_url += `&scope=${scopes}`;
      oauth_get_url += `&client_id=${client_id}`;
      oauth_get_url += `&state=superstate`;
      oauth_get_url += `&code_challenge_method=S256`;
      oauth_get_url += `&code_challenge=${code_challenge}`;

      var code = urlParams.code;
      if (code) {
        $('body').append(`<textarea value="${code}">${code}</textarea>`);
      }

      $('#oauthlink').attr('href', oauth_get_url);

      if (!client_id) {
        $('#oauthlink').after(`<br><span style="color:red">needs client id as param</span>`);
      }
      if (!code_challenge) {
        $('#oauthlink').after(`<br><span style="color:red">needs code_challenge as param</span>`);
      }
    </script>

  </body>
</html>
