<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="index.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">
    <link rel="stylesheet" href="common.css">
    <style>
      body * {
        font-size: 0.9em !important;
      }
      h5 p, p {
        font-weight: 400;
        font-size: 0.8em;
        color: #888;
        display: inline;
      }
      textarea {
        margin-left: 3px;
        margin-top: 2px;
        width: 550px;
      }
      .item {
        display: inline-block;
        font-size: 0.8em;
        color: #444;
        background-color: white;
        padding: 3px 9px;
        margin: 4px;
        border: 1px solid #ddd;
      }
      .item span {
        margin-left: 3px;
      }
      .item span:first-child {
        margin-right: 0px;
      }
      .item span.partial {
        color: #4ca24c;
        font-weight: bold;
      }
      .item span.single {
        color: #616dac;
        font-weight: bold;
      }
      .item.full_match {
        color: #29d600;
        border-color: #29d600;
        font-weight: bold;
        background-color: #e4ffe4;
      }
      .item.full_mismatch {
        color: #e23131;
        border-color: #710000;
        font-weight: bold;
        background-color: #ff8080;
      }
      .item.partial_mismatch {
        color: #ff8217;
        border-color: #b15200;
        font-weight: bold;
        background-color: #ffc7a1;
      }
      .item.partial_match {
        border-color: #4ca24c;
        background-color: #d3e8d3;
      }
      .item.single_match {
        border-color: #879aff;
        background-color: lavender;
      }
      #seoResult, #desiredResult, #todoResult {
        vertical-align: top;
      }
      .item.seo {
        padding: 2px 6px;
        font-size: 0.6em;
        margin: 2px;
      }
      a.a-special {
        font-size: 25px !important;
        margin: 5px;
        opacity: 0.6;
        cursor: pointer;
      }
      a.a-special:hover {
        opacity: 1;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div id="saveSpaces"></div>
    <button id="clearData">clear</button>
    <br />

    <div style="display:inline-block; width: 66%;">
      <h5>üíñ Desired Terms<p>space separated - ignore lines with **</p></h5>
      <textarea id="desired" style="height:200px;">
        gift for him, gift for husband, anniversary gift for husband,
        wall art, wedding gift, gift for couple,
      </textarea>

      <h5>‚ùå Exclude Terms<p>space separated</p></h5>
      <textarea id="undesired" style="height:70px;">terms from, competing, listing, lake</textarea>

      <h5>‚òù Title <p>1st 40 letters readable under search result thumbnail</p><p id="titleInfo"></p></h5>
      <textarea id="title" placeholder="" maxlength="140"></textarea>

      <h5>‚öæ Category, Occasion, Holiday, etc <p>copy paste from listing after category is chosen</p></h5>
      <textarea id="category" placeholder="comma separated" maxlength="140"></textarea>
      <div id="categoryTags">
      </div>

      <h5>üèÖ Tags
        <a id="tagsExport" class="a-special" title="export to clipboard">üì§</a>
        <a id="tagsImport" class="a-special" title="import">üì•</a>
      </h5> 
      <input class="tag" id="tag1" placeholder="tag 1 DUPE FROM TITLE" maxlength="20" size="20" />
      <input class="tag" id="tag2" placeholder="tag 2 DUPE FROM TITLE" maxlength="20" size="20"  />
      <input class="tag" id="tag3" placeholder="tag 3 OCCASION" maxlength="20" size="20"  />
      <input class="tag" id="tag4" placeholder="tag 4 WHO FOR" maxlength="20" size="20"  />
      <input class="tag" id="tag5" placeholder="tag 5 WHO FOR" maxlength="20" size="20"  />
      <input class="tag" id="tag6" placeholder="tag 6 NUMBERS" maxlength="20" size="20"  />
      <input class="tag" id="tag7" placeholder="tag 7 NUMBERS" maxlength="20" size="20"  />
      <input class="tag" id="tag8" placeholder="tag 8 MISC" maxlength="20" size="20"  />
      <input class="tag" id="tag9" placeholder="tag 9 MISC" maxlength="20" size="20"  />
      <input class="tag" id="tag10" placeholder="tag 10 MISC" maxlength="20" size="20"  />
      <input class="tag" id="tag11" placeholder="tag 11 B TIER" maxlength="20" size="20"  />
      <input class="tag" id="tag12" placeholder="tag 12 B TIER" maxlength="20" size="20"  />
      <input class="tag" id="tag13" placeholder="tag 13 B TIER" maxlength="20" size="20"  />
    </div>

    <div style="display:inline-block;width: 33%;vertical-align:top;">
      <h5>Todo</h5>
      <div id="todoResult">
      </div>

      <h5>üíó Desired Terms<p id="desiredTermsDetail"></p></h5>
      <div id="desiredResult"></div>

      <h5>‚ùå Excluded Terms<p id="undesiredTermsDetail"></p></h5>
      <div id="undesiredResult"></div>
    </div>

    <br />

    <div style="display:inline-block;width: 49%;vertical-align:top;">
      <h5 style="margin-bottom:7px;">Resulting SEO<span id="seoCount"></span><p style="text-transform:none;font-size:0.7em;">‚Äç‚òùTitle&nbsp;&nbsp;&nbsp;ü§üTitle 1st 45&nbsp;&nbsp;&nbsp;üèÖpart tag&nbsp;&nbsp;&nbsp;ü•áfull tag&nbsp;&nbsp;&nbsp;‚öæpart Attr&nbsp;&nbsp;&nbsp;ü•éfull Attr</p></h5>
      <div id="seoResult">
      </div>
    </div>

    <div style="display:inline-block;width: 49%;vertical-align:top;">
      <h5>Etsy Search Data (not implemented)</h5>
      <button onclick="importListingData()" style="float:left;">import</button>
      <div id="importedListings"></div>

      <div id="etsySearchResult">
      </div>
    </div>

    <script>
      /*
        TODO: desired terms should not duplicate
        remove , from title search
        finish moving functions out of $(function(){});
        analyze etsySearchHistory
      */

      var commonWords = {
        a: true, an: true, the: true, be: true, is: true, are: true,
        at: true, to: true , or: true,
        them: true, us: true, me: true,
        of: true, have: true, in: true, that: true,
        on: true, as: true, by: true
        // for: true, from: true,
      };
      var pluralExceptions = {
        news: true, canvas: true, paris: true, brussels: true, this: true, ms: true, mrs: true,
      };
      var data, $desired, $title, $category, $tags, refresh;
      var etsySearchHistory = {
        listingOrder: [],
        listings: {}
      };

      // sets the default savespace
      // newlyweds met meaningful sentimental law bestie bff inlaw law
      // var default_save = '{"title":"Personalized Photo wedding gift couple for 3rd , 4-8 locations personalised travel Admiration Map Print idea for boyfriend or parents 6th 10","desired":"wall art, wedding gift\\ngift for couple, mountain wall art,\\nmap print,\\nanniversary gift for him \\n**gift for who?**\\nhim, her, husband, hubby, mom, dad, parents, gay\\n**single words**\\ntravel, personalized, personalised\\n**years**\\n1st, 2nd, 3rd, 4th, 5th, 6th, 7th, 8th, 9th, 10th, 15th, 20th, 30th, 40th, 50th,\\n1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 20, \\ncotton, paper, iron, bronze, wooden\\nyear, yr\\n**common search terms based on data**\\ngift, anniversary, for, year, him, her, husband, map, wedding, boyfriend, art, wall, couple, mountain,\\nfirst, 10, print,\\none, cotton","category":"Art & Collectibles, Prints, Gicl√©e, Home & Living, Home Decor, Wall Decor, Wall Hangings","tags":["1st anniversary mom","wedding gift couple","personalized photo","first milestone dad","custom mountain map","travel poster 10th 5","2nd 3rd 5th 8th 15th","20th 30th 40th 50th","wooden iron one year","paper cotton bronze","husband wife her gay","for him 4th 1 2 3 yr","personalised silver"],"categories":["art & collectibles","prints","gicl√©e","home & living","home decor","wall decor","wall hangings"]}';
      var default_save = `{"title":"Personalize travel map gift for husband, birthday, housewarming. Parent, anniversary, boyfriend, mom weve lived together. 10th 15th 25th two","desired":"**instructions**\\n**1. use \\"must have\\", \\"custom\\", \\"occasion\\" words to build title. fill with other words\\n**2. have a good mix of \\"who\\", \\"years\\", & \\"misc\\"\\n**3. have a good mix of a tier (high competition, high value) & b tier (low competition, mid value)\\n**4. can insert a few of own words\\n**5. try to avoid overlap with alt keyword listing (except for must have)\\n\\n**üëçmust have every listing**\\ntravel, map, gift, art, frame, print, gift, for\\n\\n**üëçcustom: must have 1-3**\\n**a tier**\\npersonalize, personalise, custom\\n**b tier**\\ncustomizable\\n\\n**üëçoccasion: must have 1-2**\\nanniversary, wedding, birthday, day, lived\\nb tier**\\nhousewarming\\n\\n**üëçgift for who?**\\n**a tier**\\nparent, family, husband, boyfriend, friend, mom, dad, weve, together, father, with, military, we, i\\n**b tier**\\nwife\\n\\n**üëçnumbers & years**\\n**a tier\\none, two, four, first, year\\n1st, 2nd, 3rd, 4th, 8th, 9th, 10th, 15th, 20th, 25th, 30th\\n1, 2, 3, 4, 5, 10, 20, 25, 30, 40\\n** b tier\\nsecond, third, three, yr\\n5th, 6th, 7th\\n6, 8, 11, 12, 13, 15, 50\\n\\n**üëçmisc\\n**a tier**\\nheart, journey, milestone, wanderlust, picture, artwork,\\ncotton, paper\\nnew, where, met, been, away, state, unique, special, ship, canada, welcome\\n**b tier has potential**\\nhochzeitstag, geschenk, jahrestag\\nsister, neighbor,\\nquote, lake, idea, sign, download, dorm\\nphoto, road, destination, began, story","category":"Art & Collectibles, Prints, Gicl√©e, Home & Living, Home Decor, Wall Decor, Wall Hangings","tags":["personalize travel","map gift for husband","housewarming day 9th","parent wife military","personalise custom","1st 2nd 3rd 1 2 3","second third first","ship canada welcome","where met been new","cotton paper heart","sister neighbor year","idea destination we","quote began story"],"categories":["art & collectibles","prints","gicl√©e","home & living","home decor","wall decor","wall hangings"]}`;
      localStorage.setItem('default_save', default_save);

      function importListingData() {
        var rawCode = `
        /* COPY ME TO RUN ON LISTING PAGE */
        var r = { search_terms : {} }; // results
        var p = 1; // page
        // scrape()
        function sc() {
        	// setup for listing data
        	r.listingId = window.location.pathname.split('/')[window.location.pathname.split('/').length-1];
        	r.title = $('[href="/listing/834977399"]').closest('.flag').find('[data-test-id="unsanitize"]').text() || 'error finding title';
        	r.range = $('button.dropdown-button:first').text();

        	var $next = $('button[title="Next page"]');
        	var interval = setInterval(function (){
        		// console.log('interval ' + p);
        		gpr();
        		if ($next.prop('disabled')) {
        			// show results
        			$('body').prepend(''
        				+'<div id="listing_buddy" style="position:fixed;width:100%;height:100%;z-index:999999;background-color:white;">'
        					+'<div>'
        						+'1. triple click on code below to select all</br>'
        						+'2. copy to clipboard</br>'
        						+'3. paste into listing_buddy</br>'
        						+'<button onclick="clb();">click to close</button>'
        					+'</div>'
        					+'<code>'+JSON.stringify(r)+'</code>'
        				+'</div>'
        			);
        			clearInterval(interval);
        			return;
        		}
        		p++;
        		$next.click();
        	}, 10);
        }
        // getPageResults()
        function gpr() {
        	var $table = $('table#horizontal-chart4 tr:not(".col-group")');
        	for (var i = 0; i < $table.length; i++) {
        		var rowText = $($table[i]).find('.screen-reader-only').text();
        		var search = rowText.split(': ')[0].replace(/\//g,'').replace(/"/g,'').replace(/&quot;/g,'').replace(/&#39;/g,'');
        		var visits = +rowText.split(': ')[1].replace(/,/g,'');
        		r.search_terms[search] = visits;
        	}
        }
        // closeListingBuddy()
        function clb() {
        	$('#listing_buddy').remove();
        }
        sc();
        `;

        var code = `/* RUN ON LISTING PAGE */
var r={search_terms:{}},p=1;function sc(){r.listingId=window.location.pathname.split("/")[window.location.pathname.split("/").length-1],r.title=$('[href="/listing/834977399"]').closest(".flag").find('[data-test-id="unsanitize"]').text()||"error finding title",r.range=$("button.dropdown-button:first").text();var t=$('button[title="Next page"]'),e=setInterval(function(){if(gpr(),t.prop("disabled"))return $("body").prepend('<div id="listing_buddy" style="position:fixed;width:100%;height:100%;z-index:999999;background-color:white;"><div>1. triple click on code below to select all</br>2. copy to clipboard</br>3. paste into listing_buddy</br><button onclick="clb();">click to close</button></div><code>'+JSON.stringify(r)+"</code></div>"),void clearInterval(e);p++,t.click()},10)}function gpr(){for(var t=$('table#horizontal-chart4 tr:not(".col-group")'),e=0;e<t.length;e++){var i=$(t[e]).find(".screen-reader-only").text(),n=i.split(": ")[0].replace(/\//g,"").replace(/"/g,"").replace(/&quot;/g,"").replace(/&#39;/g,""),o=+i.split(": ")[1].replace(/,/g,"");r.search_terms[n]=o}}function clb(){$("#listing_buddy").remove()}sc();
        `;
        var dataJSON = prompt(code);
        var data = JSON.parse(dataJSON);
        if (!data.search_terms || !data.listingId || !data.title || !data.range) {
          throw new Error('import invalid data');
        }
        if (!etsySearchHistory.listingOrder.includes(data.listingId)) {
          etsySearchHistory.listingOrder.push(data.listingId);
          etsySearchHistory.listings[data.listingId] = data;
        }
        localStorage.setItem('etsySearchHistory', JSON.stringify(etsySearchHistory));
        loadListingData();
      }
      function loadListingData() {
        var ls_dataJSON = localStorage.getItem('etsySearchHistory') || "{}";
        var ls_data = JSON.parse(ls_dataJSON);
        etsySearchHistory = Object.assign({}, etsySearchHistory, ls_data);
        renderListingButtons(etsySearchHistory);
      }
      function renderListingButtons(etsySearchHistory) {
        var $listingButtons = $('#importedListings');
        $listingButtons.html('');
        etsySearchHistory.listingOrder.forEach(listingId => {
          // count the visits
          var visits = 0;
          for (var term in etsySearchHistory.listings[listingId].search_terms) {
            visits += etsySearchHistory.listings[listingId].search_terms[term];
          }

          $listingButtons.append(`
            <p class="item" title="${etsySearchHistory.listings[listingId].title}">
              <a href="https://www.etsy.com/your/shops/me/stats/listings/${listingId}" target="_blank">Listing ${listingId}</a>
              <br />
              <span>${visits} searches</span>
              <br />
              <span>${etsySearchHistory.listings[listingId].range}</span>
            </p>
          `);
        });
      }

      $(function() {
        data = {};
        var $desired = $('#desired');
        var $undesired = $('#undesired');
        var $title = $('#title');
        var $category = $('#category');
        var $tags = $('.tag');
        $desired.keyup(function() { refresh(); });
        $undesired.keyup(function() { refresh(); });
        $title.keyup(function() { refresh(); });
        $tags.keyup(function(el) { refresh(); });
        $category.keyup(function(el) { refresh(); });

        loadListingData();

        // setup throttling function
        function _refresh() {
          saveData();
          displayTodo();
          displayCategory()
          analyzeSEO();
          loadSaveSpaces();
          displayTitleInfo();
        }
        refresh = _.throttle(_refresh, 1500);

        $('#clearData').on('click',function() {
          var savespace = getSaveSpace();
          console.log(savespace);
          if (savespace != 'default') {
            var conf = confirm(`This will clear out saved [${savespace}] space. Proceed?`);
            if (!conf) return false;
          }
          $undesired.val('');
          $desired.val('');
          $title.val('');
          $category.val('');
          for (var i = 0; i < 13; i++) {
            $($tags[i]).val('');
          }
          refresh();
        });

        $('#tagsExport').on('click', function() {
          exportTags();
        });
        $('#tagsImport').on('click', function() {
          importTags();
        });

        loadData();
        loadSaveSpaces();

        function getSaveSpace() {
          return localStorage.getItem('save_space') || 'default';
        }

        function loadData() {
          // load page
          var saveSpace = localStorage.getItem('save_space') || 'default';
          var saveSpaces = localStorage.getItem('save_spaces') || `{"default":true}`;
          saveSpaces = JSON.parse(saveSpaces);
          var saved = localStorage.getItem(`${saveSpace}_save`) || "{}";
          saved = JSON.parse(saved);
          if (Object.keys(saved).length > 0) {
            $desired.val(saved.desired);
            $undesired.val(saved.undesired);
            $title.val(saved.title);
            $category.val(saved.category);
            for (var i = 0; i < 13; i++) {
              $($tags[i]).val(saved.tags[i]);
            }
          }
          refresh();
        }

        async function exportTags() {
          var tagText = '';
          for (var i = 0; i < 13; i++) {
            if (tagText.length > 0) tagText += '\n';
            var tagValue = $(`#tag${i+1}`).val();
            if (!tagValue) tagValue = '??';
            tagText += tagValue;
          }
          console.log(tagText);
          await navigator.clipboard.writeText(tagText);
          alert('COPIED TO CLIPBOARD CTRL V to PASTE:\n'+tagText);
        }

        function importTags() {
          var values = prompt('Enter Tags, 13 separate lines');
          values = values.replace(/\"/g, '').trim();
          var split = values.split('\n');
          console.log(split.length, values);
          if (split.length != 13) {
            alert('üí•Did not get 13 tags, got '+split.length);
            throw new Error('wrong count of tags');
          }
          var tags = [];
          for (var i = 0; i < split.length; i++){
            var tag = split[i].replace('\r','').replace('\n','').trim();
            if (tag.length > 20) {
              alert(`üí•tag ${i+1} "${tag}" is over 20 chars in length (${tag.length})`);
              throw new Error('tag too long');
            }
            tags.push(tag);
          }
          for (var i = 0; i < tags.length; i++) {
            $(`#tag${i+1}`).val(tags[i]);
          }
          refresh();
        }

        function loadSaveSpaces() {
          var saveSpace = localStorage.getItem('save_space') || 'default';
          var saveSpaces = localStorage.getItem('save_spaces') || `{"default":true}`;
          saveSpaces = JSON.parse(saveSpaces);
          $('#saveSpaces').html('');
          for (var space in saveSpaces) {
            // compare data
            var $button = $(`<button id="space_${space.toLowerCase().trim()}" space="${space.toLowerCase().trim()}">${space}</button>`);
            $button.on('click', function() {
              var s = $(this).attr('space');
              localStorage.setItem('save_space', s.toLowerCase().trim());
              loadSaveSpaces();
              loadData();
            });
            if (space == saveSpace) $button.attr('class','primary');
            $('#saveSpaces').append($button);
          }

          var $newSave = $('<button>new save</button>');
          $newSave.on('click', function() {
            var name = prompt('name save');
            newSaveSpace(name);
          });
          $('#saveSpaces').append($newSave);

          var $deleteSave = $('<button>delete</button>');
          $deleteSave.on('click', function() {
            var name = prompt('name of save to delete');
            if (name == 'default') return;
            localStorage.removeItem(`${name}_save`);
            localStorage.setItem('save_space', 'default');
            var spaces = localStorage.getItem('save_spaces') || '{}';
            spaces = JSON.parse(spaces);
            delete spaces[name];
            localStorage.setItem('save_spaces', JSON.stringify(spaces));
            loadSaveSpaces();
          });
          if (saveSpace != 'default') $('#saveSpaces').append($deleteSave);
        }

        function newSaveSpace(name) {
          var saveSpaces = localStorage.getItem('save_spaces') || `{"default":true}`;
          saveSpaces = JSON.parse(saveSpaces);
          saveSpaces[name.toLowerCase().trim()] = true;
          localStorage.setItem('save_space', name.toLowerCase().trim());
          localStorage.setItem('save_spaces', JSON.stringify(saveSpaces));
          saveData();
          loadSaveSpaces();
        }

        function getData() {
          data = {
            title: $title.val().trim(),
            desired: $desired.val().toLowerCase().trim(),
            undesired: $undesired.val().toLowerCase().trim(),
            category: $category.val().trim(),
            tags: []
          };
          data.categories = categoryIntoTags(data.category);
          for (var i = 0; i < 13; i++) {
            data.tags[i] = $tags[i].value.toLowerCase().trim();
          }
          return data;
        }

        function saveData() {
          var saveSpace = localStorage.getItem('save_space') || 'default';
          var saveSpaces = localStorage.getItem('save_spaces') || `{"default":true}`;
          saveSpaces = JSON.parse(saveSpaces);
          data = getData();
          localStorage.setItem(`${saveSpace}_save`, JSON.stringify(data));
        }

        function categoryIntoTags(categoryString = "") {
          categoryString = categoryString.trim().replace(/\&/g, '').replace(/\n/g, ' ').replace(/\"/g, ' ');
          var attributes = [];
          categoryString.split(',').forEach(category => {
            attributes.push(category.toLowerCase().trim());
          });
          return attributes;
        }

        function parseDesired() {
          var repeats = {};
          var desiredStr = $desired.val().toLowerCase();
          desiredStr = desiredStr.replace(/\[/g, ' ').replace(/\]/g, ' ').replace(/\//g, ' ').replace(/\"/g, ' ');
          var strings = desiredStr.split('\n');
          // filter out ** lines
          strings = strings.filter(item => {
            return !item.includes('*');
          });
          var search_terms = [];
          strings.forEach((string) => {
            string.replace(/,/g, ' ').split(' ').forEach(word => {
              var word = word.toLowerCase().trim();
              if (!repeats[word]) {
                repeats[word] = true;
                search_terms.push(word)
              }
            });
          });
          search_terms = search_terms.filter((term) => {
            return term != '';
          });
          console.log('PARSEDESIRED', search_terms);
          return search_terms;
        }

        function parseExcluded() {
          var str = $('#undesired').val();
          var strings = str.split('\n');
          // filter out ** lines
          strings = strings.filter(item => {
            return !item.includes('*');
          });
          var search_terms = [];
          strings.forEach((string) => {
            string.split(',').forEach(word => {
              search_terms.push(word.trim())
            });
          });
          search_terms = search_terms.filter((term) => {
            return term != '';
          });

          return search_terms;
        }

        function displayTitleInfo() {
          var data = getData();
          $('#titleInfo').text(`${data.title.length}/140`);
        }

        function displayDesired(desired, desiredObj, seo, seoObj, excluded) {
          // sort excluded into unique words
          var excludedWords = {};
          excluded.forEach(word => {
            word.split(' ').forEach(wordb => {
              excludedWords[wordb.trim().toLowerCase()] = true;
            });
          });
          console.log('excludedWords', excludedWords);

          var $desired = $('#desiredResult');
          var matchCount = 0;
          $desired.html('');
          desired.forEach(desire => {
            // don't show excluded words
            desire = desire.toLowerCase().trim();
            if (excludedWords[desire]) return;

            var $desire = $(`<p class="item"></p>`);
            if (desiredObj[desire].full_match) {
              matchCount++;
              $desire.addClass('full_match').text(desire);
              for (var word in desiredObj[desire].words) {
                desiredObj[desire].words[word] = 3;
              }
            } else {
              desire.split(' ').forEach(word => {
                if (desiredObj[desire].words[word] ==  2) {
                  $desire.append(`<span class="partial">${word}</span>`);
                } else if (desiredObj[desire].words[word] ==  1) {
                  $desire.append(`<span class="single">${word}</span>`);
                } else {
                  $desire.append(`<span class="none">${word}</span>`);
                }
              });
            }
            var minMatch = 3;
            var maxMatch = 0;
            for (var word in desiredObj[desire].words) {
              var wordScore = desiredObj[desire].words[word];
              if (wordScore < minMatch) minMatch = wordScore;
              if (wordScore > maxMatch) maxMatch = wordScore;
            }
            if (minMatch >= 1 && maxMatch == 2) {
              $desire.addClass('partial_match');
              matchCount++;
            } else if (minMatch == 1) {
              $desire.addClass('single_match');
              matchCount++;
            }
            $desired.append($desire);
          });
          $('#desiredTermsDetail').text(`${matchCount}/${desired.length} matched : ${((matchCount/desired.length) * 100).toFixed(2)}%`);

          // now find words in SEO that didn't match desires
          var undesired = [];
          undesiredObj = {};
          desiredWords = {}
          desired.forEach(d => {
            d.split(' ').forEach(dWord => {
              desiredWords[dWord] = true;
            });
          });
          seo.forEach(s => {
            if (s.split(' ').length == 1) {
              if (!desiredWords[s] && !undesiredObj[s]) {
                undesiredObj[s] = true;
                undesired.push(s);
              }
            }
          });

          $desired.append('<h5>‚ùìDesired?<p>found in SEO but not in Desired (above)</p></h5>');
          undesired.forEach(u => {
            $desired.append(`<p class="item">${u}</p>`);
          });
        }

        function displayCategory() {
          var data = getData();
          var $category = $('#categoryTags');
          $category.html('');
          data.categories.forEach(category => {
            $category.append(`<input name="category_${category}" value="${category}" disabled />`)
          });
        }

        function deplural(word) {
          if (word.charAt(word.length-1) == 's' && word.length > 2 && !pluralExceptions[word]) {
            return word.substring(0, word.length-1);
          }
          return word;
        }

        function displayTodo() {
          var data = getData();
          var tags = data.tags.map(tag => tag);
          // add categories to tags
          // deplural categories, to match against tags which should be singular
          var categoryByWord = {};
          data.categories.forEach((category) => {
            categoryByWord[deplural(category.toLowerCase())] = true;
            tags.push(deplural(category.toLowerCase()));
          });
          var todoIssue = [];
          var todo = [];
          if (data.title == '') {
            todoIssue.push('Enter title');
          } else if (data.title.length < 60) {
            todo.push(`Title could be longer (${data.title.length}/140)`);
          }
          for (var i = 0; i < 13; i++) {
            var tag = data.tags[i];
            if (tag == '') {
              todoIssue.push(`tag ${i+1} missing`);
            } else if (tag.length <= 16) {
              todo.push(`tag [${tag}] has space for another word`);
            }
          }
          if (data.category.length < 10) {
            todoIssue.push('missing Category & other attributes');
          }
          // check for repeated tag words
          for (var i = 0; i < tags.length; i++) {
            var tagI = ' '+tags[i] + ' ';
            var isCategory_i = (tags[i] in categoryByWord);
            for (var j = i+1; j < tags.length; j++) {
              var isCategory_j = (tags[j] in categoryByWord);
              var matchedPartials = {};
              var comparePartials = getPartials(tags[j]);
              comparePartials.forEach(cp => {
                //  console.log(`[${tags[i]}]`, 'contains', cp, '?');
                if (tagI.includes(` ${cp} `)) { // uh oh, repeat
                  // but has it been matched already?
                  var alreadyMatched = false;
                  for (var matchedPartial in matchedPartials) {
                    if (matchedPartial.includes(cp)) {
                      alreadyMatched = true;
                    }
                  }
                  // new match!
                  if (alreadyMatched == false && (isCategory_i == false || isCategory_j == false)) {
                    matchedPartials[cp] = true;
                    todo.push(`${(isCategory_i) ? 'attr' : 'tag'} [${tags[i]}] & ${(isCategory_j) ? 'attr' : 'tag'} [${tags[j]}] share "${cp}"`);
                  }
                }
              });
            }
          }
          // DONE deplural attributes
          // DONE check tags for stupid words & plural
          data.tags.forEach((tag) => {
            tag.split(' ').forEach(word => {
              if (word.trim().charAt(word.length-1) == 's' && word.length > 2 && !pluralExceptions[word]) {
                todo.push(`tag [${tag}] "${word}" might be plural, could save space`);
              }
              if (word.trim() in commonWords) {
                todo.push(`tag [${tag}] "${word}" is common and may not be good use of space`);
              }
            });
          });
          //
          // DONE check first 45 of title for stupid words & plural
          // DONE check first 45 of title for dupes
          // DONE plural (save space)
          var title45 = getTitle45(data.title).split(' ');
          var title45Words = {};
          title45.forEach(word => {
            if (title45Words[word]) todoIssue.push(`title repeats "${word}" in premium 1st 45 chars`);
            title45Words[word] = true;
            if (word in commonWords) todo.push(`title premium 1st 45 chars has useless word "${word}"`);
          });
          var titleWords = {};
          data.title.toLowerCase().split(' ').forEach(word => {
            if (titleWords[word.trim()]) todo.push(`title repeats "${word}"`);
            titleWords[word.trim()] = true;
          });

          // match 1 - 3 tags exactly to title for power
          var title45 = getTitle45(data.title).toLowerCase().trim();
          var fullTitle = data.title.toLowerCase().trim();
          var tagMatch = 0;
          var tagFullMatch = 0;
          data.tags.forEach(tag => {
            if (title45.includes(tag)) tagMatch++;
            if (fullTitle.includes(tag)) tagFullMatch++;
          });
          if (tagMatch == 0) todoIssue.push('at least 1 tag should fully exist in first 45 of title');
          if (tagFullMatch < 2) todo.push('at least 2 tags should fully exist the title');

          var $todo = $('#todoResult');
          $todo.html('');
          todoIssue = todoIssue.reverse();
          todo = todo.reverse();
          todoIssue.forEach(term => {
            $todo.append(`<p class="item">‚õî ${term}</p>`);
          });
          todo.forEach(term => {
            $todo.append(`<p class="item">ü§î ${term}</p>`);
          });

          if (todo.length == 0 && todoIssue.length == 0) $todo.append(`‚úÖ`)
        }

        function analyzeSEO() {
          var data = getData();

          // organize desired
          var desired = parseDesired();
          var desiredObj = {};
          desired.forEach(desire => {
            desire = desire.toLowerCase().trim();
            desiredObj[desire] = {
              words: {},
              full_match: false,
              term: desire
            };
            desire.split(' ').forEach(desireWord => {
              desiredObj[desire].words[desireWord] = 0;
            });
          });

          // algo - get a list of all the seo substrings, cataloging their source
          // i.e. from full_tag, from partial_tag, from full category, from title45, from title,
          var seoObj = {};
          var seo = [];

          // title
          var title45 = getTitle45(data.title).replace(/-/g,' ').replace(/‚Ñ¢/g,'').replace(/\./g,'').replace(/\,/g,'');
          var title45Partials = getPartials(title45);
          var titlePartials = getPartials(data.title.replace(/\-/g,' ').replace(/‚Ñ¢/g,'').replace(/\./g,'').replace(/\,/g,''));
          // console.log(titlePartials);
          title45Partials.forEach(partial => {
            if (partial == '') return;
            if (!seoObj[partial]) {
              seoObj[partial] = { term: partial, order: seo.length, isTitle: true, isTitle45: true };
              seo.push(partial);
            }
          });
          titlePartials.forEach((partial) => {
            if (partial == '') return;
            if (!seoObj[partial]) {
              seoObj[partial] = { term: partial, order: seo.length, isTitle: true };
              seo.push(partial);
            }
          });

          // tags
          data.tags.forEach(tag => {
            var partials = getPartials(tag);
            partials.forEach(partial => {
              if (partial == '') return;
              if (!seoObj[partial]) {
                seoObj[partial] = { term: partial, order: seo.length  };
                seo.push(partial);

              }
              seoObj[partial].isTag = true;
              if (partial == tag) seoObj[partial].isTagFull = true;
            });
          });

          // categories
          data.categories.forEach(tag => {
            var partials = getPartials(tag);
            partials.forEach(partial => {
              if (partial == '') return;
              var partial = deplural(partial);
              if (!seoObj[partial]) {
                seoObj[partial] = { term: partial, order: seo.length  };
                seo.push(partial);
                seoObj[partial].isCategory = true;
                if (partial == tag) seoObj[partial].isCategoryFull = true;
              } else {
                seoObj[partial].isCategory = true;
                if (partial == tag) seoObj[partial].isCategoryFull = true;
              }
            });
          });

          // go through seo to look for full / partial matches to desired
          for (var desire in desiredObj) {
            // look for full match in seo
            for (var s in seoObj) {
              // get partials and do word matching
              var partialLength = s.split(' ').length;
              var partial = s;
              var paddedDesire = ` ${desire} `;
              if (partial.trim() == desire.trim()) {
                desiredObj[desire].full_match = true;
              } else if (paddedDesire.includes(' '+partial+' ') && partialLength > 1) {
                partial.split(' ').forEach(p => {
                  if (desiredObj[desire].words[p] < 2) desiredObj[desire].words[p] = 2;
                });
              } else if (paddedDesire.includes(' '+partial+' ') && partialLength == 1) {
                if (desiredObj[desire].words[partial] < 1) desiredObj[desire].words[partial] = 1;
              }
            }
          }

          var excluded = parseExcluded();

          displayDesired(desired, desiredObj, seo, seoObj, excluded);

          console.log('seo', seo);
          console.log('seoObj', seoObj);
          console.log('excluded', excluded);
          displayExcluded(seoObj, excluded);

          // sort seo by power rankings
          seo = seo.map((s) => {
            seoObj[s].score = 1000 - seoObj[s].order;
            if (seoObj[s].isTitle45) seoObj[s].score += 2000;
            if (seoObj[s].isTitle) seoObj[s].score += 3000;
            if (seoObj[s].isTagFull) seoObj[s].score += 1500;
            if (seoObj[s].isTag) seoObj[s].score += 1500;
            if (seoObj[s].isCategory) seoObj[s].score += 2000;
            if (seoObj[s].isCategoryFull) seoObj[s].score += 2000;
            return s;
          });
          seo = seo.sort((a, b) => {
            return seoObj[b].score - seoObj[a].score;
          });
          displaySEO(seo, seoObj);
        }
      });

      function displayExcluded(seoObj, excluded) {
        var $undesiredResult = $('#undesiredResult');
        $undesiredResult.html('');
        var $undesiredDetail = $('#undesiredTermsDetail');
        $undesiredDetail.html('');
        var excludedCount = 0;
        var partialExcludedCount = 0;
        for (var i = 0; i < excluded.length; i++) {
          var excludeSplit = excluded[i].split(' ');
          excludeSplit.forEach(word => {
            word = word.toLowerCase();
            var score = testExcludedWord(word, seoObj);
            var $item = $(`<p class="item undesired">${word}</p>`);
            if (score > 0 && score < 1000) {
              partialExcludedCount++;
              $item.addClass('partial_mismatch').attr('title', 'partial excluded term detected');
            }
            if (score >= 1000) {
              $item.addClass('full_mismatch').attr('title', 'excluded term found');
              excludedCount++;
            }
            $undesiredResult.append($item);
          });
        }
        var message = '';
        if (excludedCount) message += `${excludedCount} excluded term(s) detected. `;
        if (partialExcludedCount) {
          message += `${partialExcludedCount} excluded term(s) partially present.`;
        }
        if (message) {
          $undesiredDetail.text(message);
        }
      }

      function testExcludedWord(word, seoObj) {
        // > 0 = partial > 1000 = full match
        var score = 0;
        for (var key in seoObj) {
          var keyLC = key.toLowerCase();
          if (keyLC == word) {
            score = 1000;
          } else if (keyLC.length > 2 && word.length > 2) {
            // only respect partials if both words are 3 letter or longer
            if (keyLC.indexOf(word) > -1 || word.indexOf(keyLC) > -1) {
              score += 1;
            }
          }
        }
        return score;
      }

      function displaySEO(seo, seoObj) {
        var $seoResult = $('#seoResult');
        $seoResult.html('');
        seo.forEach(s => {
          var glyphs = '';
          if (seoObj[s].isTitle45) glyphs = '‚òù';
          if (seoObj[s].isTitle) glyphs = 'ü§ü';
          if (seoObj[s].isTagFull) {
            glyphs += 'ü•á';
          } else if (seoObj[s].isTag) {
            glyphs += 'üèÖ';
          }
          if (seoObj[s].isCategoryFull) {
            glyphs += 'ü•é';
          } else if (seoObj[s].isCategory) {
            glyphs += '‚öæ';
          }
          if (glyphs != '') glyphs += ' ';
          var item = $(`<p class="item seo">${glyphs}${s}</p>`);
          $seoResult.append(item);
        });
        $('#seoCount').text(` √ó ${seo.length} `);
      }

      function getTitle45(title) {
        var title45 = '';
        title.toLowerCase().trim().split(' ').forEach(word => {
          if (title45 != '' && title45.length + 1 + word.trim().length < 45) title45 += ' ';
          if (word.trim().length + title45.length < 45) {
            title45 += word.trim();
          }
        });
        return title45;
      }

      function getPartials(string) {
        var words = string.toLowerCase().split(' ');
        var rawLength = words.length;
        var partials = {};
        var sortedPartials = [];
        for (var wordLength = 1; wordLength < rawLength; wordLength++) {
          // console.log('wordLength', wordLength);
          for (var i = 0; i <= rawLength - wordLength; i++) {
            // console.log(i, '->', i+wordLength);
            var partialCandidate = words.slice(i, i+wordLength).join(' ');
            if (!partials[partialCandidate]) {
              partials[partialCandidate] = true;
              sortedPartials.push(partialCandidate);
            }
          }
        }
        // filter out partials with length of 8+
        sortedPartials = sortedPartials.filter((candidate) => {
          return candidate.split(' ').length < 8;
        });
        // add the full string
        if (string.split(' ').length < 8) sortedPartials.push(string);
        return sortedPartials.reverse();
      }
    </script>
  </body>
</html>
